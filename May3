#define LDRpin A0 // pin where we connected the LDR and the resistor
/* ARDUINO LINE FOLLOWER CODE
 * Bahar, Tina, Jaclyn
 * May 3, 2019
 * CHANGES:
 * person             date              changes
 * Tina               May 3, 2019       initial creation of file
 * Bahar              May 17, 2019      added movement and ldr value processing methods
 */

// GLOBAL VARIABLES

int in1 = 13;
int in2 = 12;

// Motor B
int in3 = 8;
int in4 = 7;

// PWM
int aSpeed = 6;
int bSpeed = 5;

// LDR (Orientation)
int orientationLDR = A0;

//LED Light
int led = 4;
//value for white
int white=0;

unsigned int timePast = 0;
unsigned int lastTime = 0;
unsigned int temp=0;

// SETUP

void setup() {
  Serial.begin(9600); //sets serial port for communication
  // PWM Pins
  pinMode(aSpeed, OUTPUT);
  pinMode(bSpeed, OUTPUT);
  // Motor direction control
  pinMode(in1, OUTPUT);
  pinMode(in2, OUTPUT);
  pinMode(in3, OUTPUT);
  pinMode(in4, OUTPUT);
  //LED
  pinMode (led, OUTPUT);
  // LDR Calibration
  pinMode(orientationLDR, INPUT);
  // LDRbn 
  pinMode(A0, INPUT);
  // turn on led, set up what numbers are black and white
  digitalWrite(led, HIGH);
  initializeLDR();
}

// initializes ldr black and white values
void initializeLDR(){
  int sum=0;
  for (int x=0;x<20;x++){
    sum+=analogRead(LDRpin);
  }
  white=sum/20;
  white=400;
}

// GETS

// prints LDR output on serial monitor
void getLDR(){
  Serial.println(analogRead(LDRpin));
}

// checks to see what colour (black or white) is in front of it
// outputs 0 for white, 1 for black
boolean checkEdge(){
  if (analogRead(LDRpin) < 400) {
    return 1;
  }
  return 0;
}

// MOVEMENT

// moves car left if senses black
void moveLeft(){
   // Turn on motor A
  digitalWrite(in1, LOW);
  digitalWrite(in2, HIGH);
  // Turn on motor B
  digitalWrite(in3, LOW);
  digitalWrite(in4, HIGH);
  // Set speed to 200 out of possible range 0~255
  analogWrite(aSpeed, 80);
  // Set speed to 200 out of possible range 0~255
  analogWrite(bSpeed, 105);
}

// moves car left more if senses black for a long time
void moveLeftMore(){
   // Turn on motor A
  digitalWrite(in1, LOW);
  digitalWrite(in2, HIGH);
  // Turn on motor B
  digitalWrite(in3, LOW);
  digitalWrite(in4, HIGH);
  // Set speed to 200 out of possible range 0~255
  analogWrite(aSpeed, 150);
  // Set speed to 200 out of possible range 0~255
  analogWrite(bSpeed, 80);
}

// turn car right until edge is found
void moveRight(){
  if (timePast<900){
    // Turn on motor A
    digitalWrite(in1, LOW);
    digitalWrite(in2, HIGH);
    // Turn on motor B
    digitalWrite(in3, HIGH);
    digitalWrite(in4, LOW);
    // Set speed to 200 out of possible range 0~255
    analogWrite(aSpeed, 100);
    // Set speed to 200 out of possible range 0~255
    analogWrite(bSpeed, 1);
  }
  else if (timePast<2500){       // if it's white for a long time, the path may be an arrow shape and the car has to turn backwards on 1 wheel
    digitalWrite(in1, HIGH);
    digitalWrite(in2, LOW);
    // Turn on motor B
    digitalWrite(in3, HIGH);
    digitalWrite(in4, LOW);
    // Set speed to 200 out of possible range 0~255
    analogWrite(aSpeed, 1);
    // Set speed to 200 out of possible range 0~255
    analogWrite(bSpeed, 100);
  }
  else{       // if it's white for a long time, the path may be an L shape and the car has to turn on its own axis (both wheels move opposite sides)
    // Turn on motor A
    digitalWrite(in1, HIGH);
    digitalWrite(in2, LOW);
    // Turn on motor B
    digitalWrite(in3, HIGH);
    digitalWrite(in4, LOW);
    // Set speed to 200 out of possible range 0~255
    analogWrite(aSpeed, 80);
    // Set speed to 200 out of possible range 0~255
    analogWrite(bSpeed, 80);
  }
}

// MAIN
void loop() {
  if (checkEdge()){
    lastTime = millis();
    // move left for at least half a second so it can find black tape that's not on straight path and not miss it
    temp=millis();
    while (temp-lastTime<600){
      moveLeft();
      temp=millis();
      //if (checkEdge()){
       // delay (50);
      //}
    }
    
    if (checkEdge()){
      lastTime = millis();
      temp = millis();
      while (temp - lastTime<800)
      {
        moveLeftMore();
        temp=millis();
      }
    }
    timePast = 0;
    lastTime = millis();
  }
  else{
    moveRight();
    timePast = millis()-lastTime;
  }
  //Serial.println(analogRead(LDRpin));
}
